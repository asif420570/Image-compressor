<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Image Compressor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root {
  --bg-main: #f4f6f8;
  --bg-container: #ffffff;
  --color-primary: #007BFF;
  --color-primary-hover: #0056b3;
  --color-success: #28a745;
  --color-text: #343a40;
  --color-text-light: #6c757d;
  --border-color: #dee2e6;
  --border-dashed: #adb5bd;
  --shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.02);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg-main);
  color: var(--color-text);
  line-height: 1.6;
}

#root {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 2rem 1rem;
}

.app-container {
  width: 100%;
  max-width: 960px;
  background-color: var(--bg-container);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 2rem;
  transition: all 0.3s ease-in-out;
}

/* Header */
.app-header {
  text-align: center;
  margin-bottom: 2rem;
}

.app-header h1 {
  font-size: 2.25rem;
  font-weight: 700;
  color: var(--color-text);
}

.app-header p {
  font-size: 1rem;
  color: var(--color-text-light);
  margin-top: 0.5rem;
}

/* Upload Zone - UPDATED STYLES */
.upload-zone {
  border: 2px dashed transparent;
  border-radius: 12px;
  padding: 3rem;
  text-align: center;
  background-color: #fafafa;
  transition: border-color 0.3s, background-color 0.3s;
  margin-bottom: 2rem;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 1rem;
}

.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--color-primary);
  background-color: #f0f6ff;
}

.upload-hint {
    color: var(--color-text-light);
    font-size: 0.9rem;
}

.upload-input {
  display: none;
}

/* Global Actions */
.global-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
  align-items: center;
  margin-bottom: 1rem;
  padding: 1.5rem;
  background-color: #f8f9fa;
  border-radius: 12px;
}

.global-target-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  justify-content: center;
  align-items: center;
  margin-bottom: 2rem;
  padding: 1rem 1.5rem;
  background-color: #f8f9fa;
  border-radius: 12px;
}

/* Results List */
.results-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Result Card - NEW STYLES */
.result-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1.5rem;
  padding: 1rem;
  background-color: var(--bg-container);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  transition: box-shadow 0.3s;
}

.result-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.card-file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-grow: 1;
    min-width: 0; /* Important for ellipsis */
}

.card-thumbnail {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  flex-shrink: 0;
  background-color: #e9ecef;
}

.card-details {
  flex-grow: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.card-filename {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-size-details {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--color-text-light);
}

.card-size-new {
  font-weight: 600;
  color: var(--color-success);
}

.card-savings {
  font-size: 0.8rem;
  background-color: var(--color-success);
  color: white;
  padding: 0.1rem 0.5rem;
  border-radius: 999px;
  font-weight: 600;
}

.card-controls {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.75rem;
    flex-shrink: 0;
}

.card-status-and-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-height: 36px;
}

.card-status {
  display: flex;
  align-items: center;
  justify-content: center;
}
.card-status svg, .card-status .spinner {
    width: 20px;
    height: 20px;
}

.card-actions {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

/* Target Size Controls */
.card-target-controls {
  display: flex;
  align-items: center;
  flex-wrap: nowrap;
  gap: 0.5rem;
}

.target-size-label {
    display: none;
}
.target-size-input {
    width: 70px;
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.9rem;
}
.target-unit-select {
    padding: 0.4rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-family: inherit;
    background-color: #fff;
    font-size: 0.9rem;
}
.target-controls-buttons {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Buttons */
.btn {
  position: relative; /* For badge positioning */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: 500;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s, box-shadow 0.3s;
  text-decoration: none;
  white-space: nowrap;
}

.btn svg {
  width: 20px;
  height: 20px;
}

.btn-primary {
  background-color: var(--color-primary);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background-color: var(--color-primary-hover);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
}

.btn-primary:disabled {
  background-color: #a0c7ff;
  cursor: not-allowed;
}

/* Prominent Upload Button Style */
#select-images-btn {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 10px;
}
#select-images-btn svg {
    width: 24px;
    height: 24px;
}


.btn-small {
  padding: 0.4rem 0.8rem;
  font-size: 0.875rem;
  border-radius: 6px;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--color-text-light);
  transition: background-color 0.2s, color 0.2s;
}

.btn-icon:hover {
  background-color: #e9ecef;
  color: var(--color-text);
}

.btn-icon.remove:hover {
    background-color: #f8d7da;
    color: #721c24;
}

.btn-icon svg {
    width: 20px;
    height: 20px;
}

/* Link-style Button */
.btn-link {
  background: none;
  border: none;
  padding: 0;
  font-family: inherit;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--color-primary);
  text-decoration: underline;
  cursor: pointer;
  transition: color 0.2s;
  white-space: nowrap;
}
.btn-link:hover:not(:disabled) {
  color: var(--color-primary-hover);
}
.btn-link:disabled {
  color: var(--color-text-light);
  cursor: not-allowed;
  text-decoration: none;
}


/* Spinner */
.spinner {
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0, 0, 0, 0.2);
  border-radius: 50%;
  border-top-color: var(--color-primary);
  animation: spin 1s ease-in-out infinite;
}

.btn .spinner {
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: #fff;
}

/* Badge */
.badge {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: var(--color-primary-hover);
  color: white;
  font-size: 0.8rem;
  font-weight: 600;
  display: none; /* Hidden by default */
  align-items: center;
  justify-content: center;
  line-height: 1;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  border: 2px solid white;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 767px) {
  .app-container {
    padding: 1.5rem;
  }
  .upload-zone {
      padding: 1.5rem;
  }
  .global-actions, .global-target-controls {
      flex-direction: column;
      align-items: stretch;
  }
  
  .result-card {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }

  .card-controls {
    align-items: flex-start;
    width: 100%;
    flex-direction: row;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .card-status-and-actions {
    order: 2;
  }

  .card-target-controls {
    order: 1;
  }
}

/* Footer Section */
.app-footer {
  margin-top: 4rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border-color);
  color: var(--color-text-light);
}

.app-footer h1, .app-footer h2, .app-footer h3 {
  color: var(--color-text);
  margin-bottom: 1rem;
}

.app-footer h1 {
  font-size: 1.8rem;
  font-weight: 700;
  text-align: center;
}

.app-footer h2 {
  font-size: 1.1rem;
  font-weight: 400;
  text-align: center;
  margin-bottom: 2rem;
}

.app-footer h3 {
  font-size: 1.4rem;
  font-weight: 600;
  margin-top: 2rem;
}

.app-footer p, .app-footer li, .app-footer dd {
  font-size: 0.95rem;
  margin-bottom: 0.75rem;
}

.app-footer ol, .app-footer ul {
  padding-left: 1.5rem;
  list-style-position: outside;
}

.app-footer strong {
    font-weight: 600;
    color: var(--color-text);
}

.app-footer hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 2rem 0;
}

.app-footer dl dt {
  font-weight: 600;
  color: var(--color-text);
  margin-top: 1rem;
}

.app-footer dl dd {
  margin-left: 0;
  padding-left: 1rem;
  border-left: 3px solid var(--border-color);
}
</style>
</head>
<body>
    <div id="root">
        <div class="app-container">
            <header class="app-header">
                <h1>Smart Image Compressor</h1>
                <p>Compress images to a target file size. Fast, private, and free.</p>
            </header>

            <main>
                <div id="upload-container">
                     <div class="upload-zone" id="upload-zone">
                        <button id="select-images-btn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            Select Images
                        </button>
                        <p class="upload-hint">or drop images here</p>
                    </div>
                </div>

                <div id="results-container" style="display: none;">
                    <section class="global-actions">
                        <button id="add-more-btn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                             Add More Images
                        </button>
                        <button id="download-all-btn" class="btn btn-primary">
                            <span id="download-all-default">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>
                                Download All as ZIP
                                <span id="download-count-badge" class="badge"></span>
                            </span>
                             <span id="download-all-zipping" style="display: none;">
                                <div class="spinner"></div> Zipping...
                            </span>
                        </button>
                    </section>
                    <section class="global-target-controls">
                        <label for="global-target-size-input" class="target-size-label">Global Target Size:</label>
                        <input type="number" id="global-target-size-input" class="target-size-input" value="500">
                        <select id="global-target-unit-select" class="target-unit-select">
                            <option value="KB" selected>KB</option>
                            <option value="MB">MB</option>
                        </select>
                        <button id="apply-to-all-btn" class="btn btn-primary btn-small">Apply to All</button>
                    </section>
                    <section class="results-list" id="results-list"></section>
                </div>
            </main>

            <footer class="app-footer">
                <h1><strong>Smart Image Compressor: Instantly Reduce Image Size</strong></h1>
                <h2>Optimize your JPG, PNG, and WEBP images for the web. Our free photo compressor makes your website faster without sacrificing quality.</h2>

                <hr>

                <h3><strong>How to Compress Your Image in 3 Simple Steps</strong></h3>
                <ol>
                    <li><strong>Upload Your Image:</strong> Simply drag and drop your image file onto the upload area, or click to browse and select your picture.</li>
                    <li><strong>Compress Instantly:</strong> Your image is automatically compressed to a balanced, optimal size. For more control, use our advanced settings to achieve the exact file size you need.</li>
                    <li><strong>Download Your File:</strong> Click the "Download" button to get your new, lightweight image. See the difference in file size and enjoy a faster website!</li>
                </ol>

                <hr>

                <h3><strong>Why Our Image Compressor is the Best Choice</strong></h3>
                <ul>
                    <li><strong>üîí 100% Client-Side Processing:</strong> Your privacy and security are our top priority. Your images are never uploaded to our servers. All compression is performed directly in your browser on your own computer.</li>
                    <li><strong>‚ö° Blazing Fast Technology:</strong> Why wait? Our image optimizer uses the latest technology to compress your images in just a few seconds. There are no queues, no waiting, just instant results.</li>
                    <li><strong>‚öñÔ∏è Smart Compression Algorithm:</strong> You don't have to choose between size and quality. Our tool uses a smart algorithm to find the perfect balance, drastically reducing file size while keeping your images crisp and clear.</li>
                    <li><strong>‚úÖ Simple & Intuitive Interface:</strong> You don't need to be a technical expert to use our tool. We've designed a clean, simple interface that makes it easy for anyone to compress their images with just a few clicks. No software to install, ever.</li>
                </ul>

                <hr>

                <h3><strong>Understanding Image Compression</strong></h3>
                <p>Image compression is the process of reducing the digital size of a graphic file without a significant loss in visual quality. This is critically important for anyone with a website, as smaller image files mean faster page load times. Faster websites lead to a better user experience, higher engagement, and improved search engine rankings (SEO). Our tool uses smart "lossy" compression techniques to analyze your image and remove redundant, unnecessary data. The result is a much smaller, optimized image that is perfect for your blog, e-commerce store, email attachments, or social media posts.</p>

                <hr>

                <h3><strong>Frequently Asked Questions (FAQ)</strong></h3>
                <dl>
                    <dt><strong>Q: Is this online image compressor tool really free?</strong></dt>
                    <dd>A: Yes, this tool is 100% free to use. There are no hidden charges, and you can compress as many images as you like.</dd>
                    
                    <dt><strong>Q: Will compressing my image noticeably reduce its quality?</strong></dt>
                    <dd>A: Our tool is designed to achieve the best possible compression with a minimal impact on visual quality. For most uses on the web and social media, the difference in quality is nearly invisible to the human eye, but the reduction in file size is massive.</dd>
                    
                    <dt><strong>Q: What's the difference between this tool and desktop software?</strong></dt>
                    <dd>A: The main differences are speed and convenience. Our online tool requires no installation, is always up-to-date, and can be accessed from any device with a web browser. It's perfect for quick, everyday compression tasks without the complexity of desktop software like Photoshop.</dd>
                    
                    <dt><strong>Q: Are there any limits on the number of images I can compress?</strong></dt>
                    <dd>A: No, there are no limits. You can use the tool as much as you need. We are currently working on a batch processing feature to allow you to compress multiple images at once!</dd>
                </dl>
            </footer>

            <input
                id="file-upload"
                type="file"
                class="upload-input"
                accept="image/*"
                multiple
            />
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const fileInput = document.getElementById('file-upload');
    const uploadZone = document.getElementById('upload-zone');
    const uploadContainer = document.getElementById('upload-container');
    const resultsContainer = document.getElementById('results-container');
    const resultsList = document.getElementById('results-list');
    const addMoreBtn = document.getElementById('add-more-btn');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const downloadAllDefault = document.getElementById('download-all-default');
    const downloadAllZipping = document.getElementById('download-all-zipping');
    const downloadCountBadge = document.getElementById('download-count-badge');
    const globalTargetSizeInput = document.getElementById('global-target-size-input');
    const globalTargetUnitSelect = document.getElementById('global-target-unit-select');
    const applyToAllBtn = document.getElementById('apply-to-all-btn');


    // --- State Management ---
    let imageFilesState = [];
    let nextId = 0;

    // --- Helper Functions ---
    const formatBytes = (bytes) => {
        if (!+bytes) return '0.00 KB';
        const k = 1024;
        return `${(bytes / k).toFixed(2)} KB`;
    };

    // --- Core Application Logic ---
    const updateDownloadAllBadge = () => {
        const readyToDownloadCount = imageFilesState.filter(f => f.status === 'done' && f.compressedFile).length;
        if (readyToDownloadCount > 0) {
            downloadCountBadge.textContent = readyToDownloadCount;
            downloadCountBadge.style.display = 'flex';
        } else {
            downloadCountBadge.style.display = 'none';
        }
    };

    const render = () => {
        resultsList.innerHTML = '';
        if (imageFilesState.length === 0) {
            uploadContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
        } else {
            uploadContainer.style.display = 'none';
            resultsContainer.style.display = 'block';
        }

        imageFilesState.forEach(file => {
            const card = document.createElement('article');
            card.className = 'result-card';
            card.dataset.id = file.id;
            
            const isCompressing = file.status === 'compressing';
            const isDone = file.status === 'done';
            const isError = file.status === 'error';

            let statusHTML = '';
            if (isCompressing) {
                statusHTML = `<div class="spinner" aria-label="Compressing"></div>`;
            } else if (isError) {
                statusHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" title="Error compressing image" aria-label="Error"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
            }

            let sizeDetailsHTML = `<span class="card-size-orig">${formatBytes(file.originalFile.size)}</span>`;
            if (isDone && file.compressedFile) {
                const savings = Math.round(100 - (file.compressedFile.size / file.originalFile.size) * 100);
                sizeDetailsHTML += `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px; height:16px; color: var(--color-text-light);"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>
                    <span class="card-size-new">${formatBytes(file.compressedFile.size)}</span>
                    <span class="card-savings">- ${savings}%</span>
                `;
            }

            card.innerHTML = `
                <div class="card-file-info">
                    <img src="${file.originalUrl}" alt="${file.originalFile.name}" class="card-thumbnail" />
                    <div class="card-details">
                        <p class="card-filename" title="${file.originalFile.name}">${file.originalFile.name}</p>
                        <div class="card-size-details">
                            ${sizeDetailsHTML}
                        </div>
                    </div>
                </div>
                
                <div class="card-controls">
                    ${!isError ? `
                    <div class="card-target-controls">
                        <input type="number" id="target-size-${file.id}" class="target-size-input" value="${file.targetSize}" ${isCompressing ? 'disabled' : ''} aria-label="Target size">
                        <select id="target-unit-${file.id}" class="target-unit-select" ${isCompressing ? 'disabled' : ''} aria-label="Target unit">
                            <option value="KB" ${file.targetUnit === 'KB' ? 'selected' : ''}>KB</option>
                            <option value="MB" ${file.targetUnit === 'MB' ? 'selected' : ''}>MB</option>
                        </select>
                        <div class="target-controls-buttons">
                            <button class="btn btn-primary btn-small btn-apply" ${isCompressing ? 'disabled' : ''}>Apply</button>
                            <button class="btn-link btn-reset" ${isCompressing ? 'disabled' : ''}>Reset</button>
                        </div>
                    </div>` : '<div></div>' /* Placeholder to keep alignment */}

                    <div class="card-status-and-actions">
                        <div class="card-status" role="status">${statusHTML}</div>
                        <div class="card-actions">
                            ${isDone && file.compressedUrl ? `
                            <a href="${file.compressedUrl}" download="compressed-${file.originalFile.name}" class="btn-icon" title="Download compressed image" aria-label="Download compressed image">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>
                            </a>` : ''}
                            <button class="btn-icon remove btn-remove" title="Remove image" aria-label="Remove image">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            resultsList.appendChild(card);
        });

        updateGlobalActions();
        updateDownloadAllBadge();
        attachCardListeners();
    };

    const attachCardListeners = () => {
        document.querySelectorAll('.result-card').forEach(card => {
            const id = parseInt(card.dataset.id, 10);
            card.querySelector('.btn-remove').addEventListener('click', () => handleRemoveImage(id));
            
            const applyBtn = card.querySelector('.btn-apply');
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    const sizeInput = card.querySelector(`#target-size-${id}`);
                    const unitSelect = card.querySelector(`#target-unit-${id}`);
                    const targetSize = parseFloat(sizeInput.value);
                    const targetUnit = unitSelect.value;
                    handleTargetSizeApply(id, targetSize, targetUnit);
                });
            }

            const resetBtn = card.querySelector('.btn-reset');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => handleReset(id));
            }
        });
    };
    
    const updateGlobalActions = () => {
        const anyCompressing = imageFilesState.some(f => f.status === 'compressing');
        const anyDone = imageFilesState.some(f => f.status === 'done');
        downloadAllBtn.disabled = anyCompressing || !anyDone;
        applyToAllBtn.disabled = anyCompressing;
    };
    
    const updateFileState = (id, updates) => {
        const index = imageFilesState.findIndex(f => f.id === id);
        if (index !== -1) {
            imageFilesState[index] = { ...imageFilesState[index], ...updates };
        }
    };

    const processFiles = (files) => {
        const newFiles = Array.from(files).map(file => ({
            id: nextId++,
            originalFile: file,
            originalUrl: URL.createObjectURL(file),
            compressedFile: null,
            compressedUrl: null,
            status: 'compressing',
            targetSize: 500,
            targetUnit: 'KB',
        }));
        
        imageFilesState = [...imageFilesState, ...newFiles];
        render();

        newFiles.forEach(file => compressWithDefaults(file.id));
    };

    const compressWithDefaults = async (id) => {
        const fileState = imageFilesState.find(f => f.id === id);
        if (!fileState) return;

        try {
            const compressed = await imageCompression(fileState.originalFile, {
                maxSizeMB: 1,
                useWebWorker: true,
            });
            updateFileState(id, {
                status: 'done',
                compressedFile: compressed,
                compressedUrl: URL.createObjectURL(compressed),
            });
        } catch (e) {
            console.error(e);
            updateFileState(id, { status: 'error' });
        } finally {
            render();
        }
    };
    
    const compressToTargetSize = async (id, targetBytes) => {
        const fileState = imageFilesState.find(f => f.id === id);
        if (!fileState) return;

        // Revoke old URL if it exists
        if (fileState.compressedUrl) URL.revokeObjectURL(fileState.compressedUrl);
        updateFileState(id, { status: 'compressing', compressedFile: null, compressedUrl: null });
        render();

        try {
            let bestBlob = null;
            // First, try a direct approach which is often good enough
            const firstTry = await imageCompression(fileState.originalFile, {
                maxSizeMB: targetBytes / 1024 / 1024,
                useWebWorker: true,
            });

            if (firstTry.size <= targetBytes) {
                bestBlob = firstTry;
            } else {
                // If direct approach fails, use binary search on quality
                let minQuality = 0;
                let maxQuality = 1;
                let currentQuality = 0.5;

                for (let i = 0; i < 8; i++) { // 8 iterations should be enough
                    const tempBlob = await imageCompression(fileState.originalFile, {
                         maxSizeMB: 10, // Set high to not interfere with quality
                         initialQuality: currentQuality,
                         useWebWorker: true,
                    });

                    if (tempBlob.size <= targetBytes) {
                        bestBlob = tempBlob;
                        minQuality = currentQuality;
                    } else {
                        maxQuality = currentQuality;
                    }
                    currentQuality = (minQuality + maxQuality) / 2;
                }
            }
            
            if (!bestBlob) {
                // If still no suitable blob, use the smallest one we found, even if over target
                bestBlob = firstTry;
            }

            updateFileState(id, {
                status: 'done',
                compressedFile: bestBlob,
                compressedUrl: URL.createObjectURL(bestBlob),
            });

        } catch (e) {
            console.error(e);
            updateFileState(id, { status: 'error' });
        } finally {
            render();
        }
    };
    
    // --- Event Handlers ---
    const handleFileChange = (event) => {
        if (event.target.files.length > 0) {
            processFiles(event.target.files);
        }
        event.target.value = ''; // Allow re-uploading same file
    };

    const handleRemoveImage = (id) => {
        const fileToRemove = imageFilesState.find(f => f.id === id);
        if (fileToRemove) {
            if (fileToRemove.originalUrl) URL.revokeObjectURL(fileToRemove.originalUrl);
            if (fileToRemove.compressedUrl) URL.revokeObjectURL(fileToRemove.compressedUrl);
        }
        imageFilesState = imageFilesState.filter(f => f.id !== id);
        render();
    };

    const handleTargetSizeApply = (id, targetSize, targetUnit) => {
        updateFileState(id, { targetSize, targetUnit });
        const multiplier = targetUnit === 'MB' ? 1024 * 1024 : 1024;
        const targetBytes = targetSize * multiplier;
        compressToTargetSize(id, targetBytes);
    };

    const handleReset = (id) => {
        const fileState = imageFilesState.find(f => f.id === id);
        if (!fileState) return;

        if (fileState.compressedUrl) URL.revokeObjectURL(fileState.compressedUrl);
        updateFileState(id, { status: 'compressing', compressedFile: null, compressedUrl: null });
        render();
        compressWithDefaults(id);
    };

    const handleApplyToAll = () => {
        const targetSize = parseFloat(globalTargetSizeInput.value);
        const targetUnit = globalTargetUnitSelect.value;
        
        if (isNaN(targetSize) || targetSize <= 0) {
            alert("Please enter a valid target size.");
            return;
        }

        const multiplier = targetUnit === 'MB' ? 1024 * 1024 : 1024;
        const targetBytes = targetSize * multiplier;
        
        imageFilesState.forEach(file => {
            // Update state with new target values before calling compress
            updateFileState(file.id, { targetSize, targetUnit });
            compressToTargetSize(file.id, targetBytes);
        });
    };

    const handleDownloadAll = async () => {
        const btnDefault = downloadAllBtn.querySelector('#download-all-default');
        const btnZipping = downloadAllBtn.querySelector('#download-all-zipping');

        btnDefault.style.display = 'none';
        btnZipping.style.display = 'inline-flex';
        downloadAllBtn.disabled = true;

        const zip = new JSZip();
        imageFilesState.forEach(file => {
            if (file.status === 'done' && file.compressedFile) {
                zip.file(`compressed-${file.originalFile.name}`, file.compressedFile);
            }
        });

        try {
            const content = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = 'compressed-images.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        } catch(e) {
            console.error(e);
            alert("Failed to create zip file.");
        } finally {
            btnDefault.style.display = 'inline-flex';
            btnZipping.style.display = 'none';
            updateGlobalActions();
        }
    };

    // --- Setup Event Listeners ---
    fileInput.addEventListener('change', handleFileChange);
    addMoreBtn.addEventListener('click', () => fileInput.click());
    downloadAllBtn.addEventListener('click', handleDownloadAll);
    applyToAllBtn.addEventListener('click', handleApplyToAll);

    // Make the entire upload zone clickable to open the file dialog
    uploadZone.addEventListener('click', () => fileInput.click());

    // Drag and Drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            processFiles(e.dataTransfer.files);
        }
    });

    // Cleanup object URLs on page leave
    window.addEventListener('beforeunload', () => {
        imageFilesState.forEach(file => {
            if (file.originalUrl) URL.revokeObjectURL(file.originalUrl);
            if (file.compressedUrl) URL.revokeObjectURL(file.compressedUrl);
        });
    });
});
</script>
</body>
</html>